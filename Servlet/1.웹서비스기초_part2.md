## 1. 웹 서비스 기초 (Part 2)

### 3. 서블릿의 이해
- 원칙적으로 ```javax.servlet.Servlet```인터페이스를 구현한 것
- 일반적인 자바 독립 실행 프로그램은 main 메서드(=psvm)가 있어서, 해당 메서드의 시작과 종료가 프로그램의 생명주기와 일치
- 반면 서블릿은 서블릿 컨테이너 내에 등록된 후 서블릿 컨테이너에 의해 생성, 호출, 소멸이 이루어진다.

**Client -> Servlet 흐름**
1. 사용자가 브라우저를 통해 웹 사이트에 접근하면 GET 요청이 브라우저에 의해 HTTP 프로토콜로 변환되어 해당 사이트를 서비스하는 서블릿 컨테이너로 전달
2. HTTP로 전달된 메시지가 서블릿 컨테이너에서 해석 및 재조합되어 프로그래머가 작성한 서블릿으로 전달
3. 해당 서블릿의 매개변수로 ServletRequest와 ServletResponse를 가지는 service 메서드가 호출되며 전달받은 메시지는 ServletRequest 인터페이스를 통해 전달


#### GenericServlet
- 서블릿 인터페이스의 구현체만 있다면 서블릿 컨테이너가 생성, 소멸 등의 생명주기 관리 작업을 수행할 수 있다.
- 서블릿 컨테이너가 서블릿 관리를 위해 필요한 기능은 서블릿 스펙에 모두 정의되어 있으므로 서블릿 명세는 서블릿에 필요한 구현을 미리 작성해 ```GenericServlet```이라는 이름으로 제공한다.
- 이 ```GenericServlet```은 추상 클래스지만 ```void service(ServletRequest req, ServletResponse res)``` 추상 메서드를 제외하고는 모두 구현된 일종의 어댑터 역할을 제공한다.
- 따라서 서블릿을 작성하는 프로그래머들은 서블릿 인터페이스를 구현하는 대신 ```GenericServlet```을 상속하여 사용한다.


#### HttpServlet
- 일반적으로 서블릿이라 하면 거의 대부분 이 ```HttpServlet```을 상속받은 서블릿을 의미한다.
- ```HttpServlet``` 또한 당연히 ```GenericServlet```을 상속받으며, 앞서 언급한 ```void service(ServletRequest req, ServletResponse res)``` 추상 메서드를 HTTP 프로토콜 요청 메서드에 적합하게 재구현하였다.
- 서블릿 컨테이너는 받은 요청에 대해 서블릿을 선택한 후 Servlet 인터페이스에 정의된 ```void service(ServletRequest req, ServletResponse res)``` 메서드를 호출
- ```HttpServlet.service``` 메서드 내부에서는 HTTP요청 메서드에 의해 여러 ```doXXX``` 메서드로 분기되어 처리
- ```HttpServlet```를 상속받아 프로그래머가 작성한 서블릿은 이 ```doXXX``` 메서드를 다시 오버라이딩하여 HTTP 메서드별로 서로 다른 처리를 수행


#### Servlet 작성하고 Servlet Container에서 돌려보기

- 예제 작성
```java

import javax.servlet.http.*;
import javax.servlet.ServletException;
import java.io.IOException;
import java.io.PrintWriter;

public class ServletExample extends HttpServlet {
  @Override
  public void init() {
	System.out.printf("%s이 초기화 되었습니다.", getServletName());
  }
  
  @Override
  public void doGet (HttpServletRequest req, HttpServletResponse res) throws ServletException, IOException {
	PrintWriter out = res.getWriter();
	out.println("Hello World \n");
  }
  
  @Override
  public void destroy() {
	System.out.print("Destroy");
  }
  
  @Override
  public String getServletName() {
	return "예제 서블릿";
  }
}

```
#### Apache Tomcat (download: https://tomcat.apache.org/download-90.cgi)
- Apache Tomcat은 오픈 소스 서블릿 컨테이너이다. 이를 이용하여 직접 서블릿 컨테이너를 빌드하고 위에 작성한 서블릿 예제를 동작시켜보자. 
- 책의 예제는 ```jdk1.6에 Apache Tomcat7```을 사용하였지만 여기서는 ```jdk17과 Apache Tomcat9```를 사용한다.
- 다운로드 받은 Tomcat 소스 빌드를 위한 도구인 ```Apache Ant``` 도 설치하여 준다. (download: https://ant.apache.org/bindownload.cgi)

1. ```Apache Ant``` 압축을 풀고 ```시스템 환경 변수``` 설정에서 ```ANT_HOME``` 변수를 설치 디렉토리 경로로 설정
2. ```PATH``` 변수에 ```ANT_HOME``` 변수로 설정했던 디렉토리의 하위에 위치한 ```/bin``` 디렉토리 경로 값 설정
3. bash에서 ```ant```커맨드를 실행하여 Tomcat 소스를 빌드해준다.
4. 빌드가 끝났다면 ```Apache Tomcat``` 설치경로 하위의 ```/output/build/bin```으로 이동 후  ```startup.bat(window 기준)```파일을 실행하면 톰캣 서버가 실행된다.
5. ```localhost:8080```에 접속해 정상 실행되었는지 확인

- 톰캣 서버를 띄우기 위해 ```startup.bat```스크립트를 실행하고, 내부적으로 ```catalina.bat```파일을 호출한다.
- 방금 빌드한 톰캣 서버가 지금 당장 호출할 수 있는 클래스는 현재 클래스패스상에 있는 두 개의 jar 파일에 포함되어있어야 함
  <br/> ```bootstrap.jar, tomcat-juli.jar```
- 그렇다면 ```ServletExample```을 서버 위에서 동작시키려면 톰캣 서버가 ```ServletExample```클래스를 찾을 방법이 있어야 한다.
- 또한 어떤 URL로 요청이 들어왔을 때 ```ServletExample```서블릿을 실행해야 한다는 것을 알려주어야 한다.
- 서블릿 컨테이너가 제공하는 이러한 일련의 과정을 배치라고 부른다.

**웹 어플리케이션 배치**
- 톰캣 서버는 시작할 때 ```webapps```디렉터리 아래에서 새로운 웹 어플리케이션을 탐색한다.
- 따라서 ```Apache Tomcat``` 소스 디렉터리 아래의 ```/output/build/webapps```안에 ```새 디렉토리(/helloWorld)```를 하나 생성한다.
- 그 아래 ```WEB-INF```와  ```/WEB-INF/classes``` 디렉터리를 만들고 ```classes``` 디렉터리 안에 위의 예제 파일(```ServletExample.java```)을 저장한다 
- ServletExample 클래스가 위치한 경로에서 ```javac -encoding UTF-8 -classpath ../../../lib/servlet-api.jar ServletExample.java``` 커맨드를 실행
- ```WEB-INF``` 디렉토리 안에 ```web.xml```파일을 만들고 내용은 하기와 같이 작성
```xml
<?xml version="1.0" encoding="UTF-8" ?>
<web-app xmlns="http://xmlns.jcp.org/xml/ns/javaee"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://xmlns.jcp.org/xml/ns/javaee
                      http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"
  version="4.0"
  metadata-complete="true">
  <servlet>
    <servlet-name>servletExample</servlet-name>
    <servlet-class>ServletExample</servlet-class>
  </servlet>
  <servlet-mapping>
    <servlet-name>servletExample</servlet-name>
    <url-pattern>/servletEx</url-pattern>
  </servlet-mapping>
</web-app>
```
- 이후 ```localhost:8080/helloWorld/servletEx``` 경로로 접근하면 브라우저에 사진과 같이 표시된다.
<img height="200" src="\images\Servlet\서블릿돌리기.jpg" width="400"/>
- 서블릿이 첫 요청을 처리하기 전에 서블릿 컨테이너는 해당 서블릿의 초기화 과정을 거치면서 해당 서블릿의 ```init``` 메서드를 호출하여준다.
- 톰캣 서버를 실행했던 커맨드창으로 가보면 "예제 서블릿이 초기화되었습니다."라는 메시지가 표시되는데 이를 통해 ```ServletExample```의 ```init```메서드가 호출되었다는 사실을 알 수 있다.